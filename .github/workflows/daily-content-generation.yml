name: Daily Content Generation

on:
  schedule:
    # Run daily at 09:00 UTC (10:00 CET, 11:00 CEST)
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      target_count:
        description: 'Number of questions to generate'
        required: false
        default: '100'
        type: string
      confidence_threshold:
        description: 'Confidence threshold for auto-publish (0.90-0.99)'
        required: false
        default: '0.99'
        type: string

jobs:
  generate-content:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Generate AI Content
        run: |
          echo "Starting automated content generation..."

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger with custom params
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              -d '{"targetCount": ${{ github.event.inputs.target_count }}, "confidenceThreshold": ${{ github.event.inputs.confidence_threshold }}}' \
              "${{ secrets.APP_URL }}/api/cron/generate-content")
          else
            # Scheduled trigger with default params
            RESPONSE=$(curl -s -w "\n%{http_code}" -X GET \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              "${{ secrets.APP_URL }}/api/cron/generate-content")
          fi

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "❌ Content generation failed with status $HTTP_CODE"
            exit 1
          fi

          echo "✅ Content generation completed successfully"

          # Parse and display results
          echo "Results:"
          echo "$BODY" | jq -r '.summary | "  Generated: \(.results.generated)\n  Auto-Published: \(.results.autoPublished)\n  Queued for Review: \(.results.queuedForReview)\n  Rejected: \(.results.rejected)\n  Total Cost: $\(.results.totalCost)\n  Duration: \(.duration)s"'

      - name: Notify on failure
        if: failure()
        run: |
          echo "Content generation job failed. Check logs for details."
          # TODO: Add Slack/Discord notification here
